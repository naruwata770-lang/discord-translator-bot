# Discordè‡ªå‹•ç¿»è¨³bot - æŠ€è¡“ä»•æ§˜æ›¸

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Discord                              â”‚
â”‚                  (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°åŸºç›¤)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ WebSocket/REST API
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Discord Bot Application                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              DiscordClient (discord.js)              â”‚   â”‚
â”‚  â”‚         - ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–ï¼ˆmessageCreateï¼‰               â”‚   â”‚
â”‚  â”‚         - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             MessageHandler                           â”‚   â”‚
â”‚  â”‚         - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°                      â”‚   â”‚
â”‚  â”‚         - botè‡ªèº«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é™¤å¤–                       â”‚   â”‚
â”‚  â”‚         - å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«åˆ¤å®š                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             CommandParser                            â”‚   â”‚
â”‚  â”‚         - ã‚³ãƒãƒ³ãƒ‰è§£æï¼ˆ!translateï¼‰                   â”‚   â”‚
â”‚  â”‚         - å¼•æ•°æŠ½å‡º                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          TranslationService                          â”‚   â”‚
â”‚  â”‚         - ç¿»è¨³ãƒ­ã‚¸ãƒƒã‚¯                                â”‚   â”‚
â”‚  â”‚         - è¨€èªæ¤œå‡º                                    â”‚   â”‚
â”‚  â”‚         - ãƒªãƒˆãƒ©ã‚¤å‡¦ç†                                â”‚   â”‚
â”‚  â”‚         - ãƒ¬ãƒ¼ãƒˆåˆ¶é™                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             PoeApiClient                             â”‚   â”‚
â”‚  â”‚         - Poe APIå‘¼ã³å‡ºã—                             â”‚   â”‚
â”‚  â”‚         - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰                               â”‚   â”‚
â”‚  â”‚         - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          MessageDispatcher                           â”‚   â”‚
â”‚  â”‚         - ç¿»è¨³çµæœæ•´å½¢                                â”‚   â”‚
â”‚  â”‚         - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡                              â”‚   â”‚
â”‚  â”‚         - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ConfigStore                             â”‚   â”‚
â”‚  â”‚         - ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿                            â”‚   â”‚
â”‚  â”‚         - è¨­å®šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆzodï¼‰                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Logger (pino)                            â”‚  â”‚
â”‚  â”‚         - æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›                              â”‚  â”‚
â”‚  â”‚         - ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTPS
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Poe API                                  â”‚
â”‚              (OpenAIäº’æ›ç¿»è¨³API)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 1. DiscordClient

**è²¬å‹™**: Discord APIã¨ã®æ¥ç¶šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–

```typescript
class DiscordClient {
  private client: Client;
  private messageHandler: MessageHandler;

  constructor(config: BotConfig) {
    this.client = new Client({
      intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent,
      ],
    });
  }

  async start(): Promise<void>
  on(event: 'messageCreate', handler: (message: Message) => void): void
  async shutdown(): Promise<void>
}
```

**ä¾å­˜é–¢ä¿‚**:
- `discord.js`: Discord APIé€šä¿¡
- `MessageHandler`: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã®å§”è­²

---

### 2. MessageHandler

**è²¬å‹™**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»æŒ¯ã‚Šåˆ†ã‘

```typescript
class MessageHandler {
  private commandParser: CommandParser;
  private translationService: TranslationService;
  private config: BotConfig;

  async handle(message: Message): Promise<void> {
    // botè‡ªèº«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç„¡è¦–
    if (message.author.bot) return;

    // å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«åˆ¤å®š
    if (!this.isTargetChannel(message.channelId)) return;

    // ã‚³ãƒãƒ³ãƒ‰è§£æ
    const command = this.commandParser.parse(message.content);

    if (command) {
      await this.handleCommand(command, message);
    }
  }

  private isTargetChannel(channelId: string): boolean
  private async handleCommand(command: Command, message: Message): Promise<void>
}
```

**ä¾å­˜é–¢ä¿‚**:
- `CommandParser`: ã‚³ãƒãƒ³ãƒ‰è§£æ
- `TranslationService`: ç¿»è¨³å®Ÿè¡Œ

---

### 3. CommandParser

**è²¬å‹™**: ã‚³ãƒãƒ³ãƒ‰ã®è§£æãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
interface Command {
  type: 'translate';
  text: string;
  sourceLang?: string;
  targetLang?: string;
}

class CommandParser {
  parse(content: string): Command | null {
    // !translate <ãƒ†ã‚­ã‚¹ãƒˆ>
    const translateRegex = /^!translate\s+(.+)$/i;
    const match = content.match(translateRegex);

    if (match) {
      return {
        type: 'translate',
        text: match[1].trim(),
      };
    }

    return null;
  }
}
```

---

### 4. TranslationService

**è²¬å‹™**: ç¿»è¨³ã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯

```typescript
class TranslationService {
  private poeClient: PoeApiClient;
  private languageDetector: LanguageDetector;
  private rateLimiter: RateLimiter;

  async translate(text: string, options?: TranslationOptions): Promise<TranslationResult> {
    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    await this.rateLimiter.acquire();

    try {
      // è¨€èªæ¤œå‡º
      const sourceLang = options?.sourceLang || await this.languageDetector.detect(text);
      const targetLang = this.determineTargetLanguage(sourceLang);

      // ç¿»è¨³å®Ÿè¡Œ
      const result = await this.poeClient.translate({
        text,
        sourceLang,
        targetLang,
      });

      return {
        translatedText: result,
        sourceLang,
        targetLang,
      };
    } catch (error) {
      // ã™ã§ã«TranslationErrorã®å ´åˆã¯ãã®ã¾ã¾å†ã‚¹ãƒ­ãƒ¼
      if (error instanceof TranslationError) {
        throw error;
      }

      // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯æ±ç”¨çš„ãªAPI_ERRORã§ãƒ©ãƒƒãƒ—
      throw new TranslationError('Translation failed', ErrorCode.API_ERROR, error as Error);
    } finally {
      this.rateLimiter.release();
    }
  }

  private determineTargetLanguage(sourceLang: string): string {
    // æ—¥æœ¬èªâ†’ä¸­å›½èªã€ä¸­å›½èªâ†’æ—¥æœ¬èª
    return sourceLang === 'ja' ? 'zh' : 'ja';
  }
}

interface TranslationOptions {
  sourceLang?: string;
  targetLang?: string;
}

interface TranslationResult {
  translatedText: string;
  sourceLang: string;
  targetLang: string;
}
```

---

### 5. PoeApiClient

**è²¬å‹™**: Poe APIã¨ã®é€šä¿¡

```typescript
class PoeApiClient {
  private apiKey: string;
  private endpointUrl: string;
  private modelName: string;
  private maxRetries = 3;
  private baseDelay = 1000; // 1ç§’

  async translate(request: TranslationRequest): Promise<string> {
    const prompt = this.buildPrompt(request);

    let lastError: Error | null = null;
    for (let attempt = 0; attempt <= this.maxRetries; attempt++) {
      try {
        const response = await this.callApi(prompt);
        return response.choices[0].message.content;
      } catch (error: any) {
        lastError = error;

        // ãƒªãƒˆãƒ©ã‚¤ä¸å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å³åº§ã«å¤±æ•—
        if (this.isNonRetryableError(error)) {
          throw error;
        }

        // æœ€å¾Œã®è©¦è¡Œã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
        if (attempt === this.maxRetries) {
          break;
        }

        // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å¾…æ©Ÿ
        const delay = this.calculateBackoffDelay(attempt, error);
        logger.warn(`API call failed, retrying in ${delay}ms (attempt ${attempt + 1}/${this.maxRetries})`, {
          error: error.message,
          statusCode: error.statusCode
        });
        await this.sleep(delay);
      }
    }

    throw lastError || new Error('Translation failed after retries');
  }

  private isNonRetryableError(error: any): boolean {
    // èªè¨¼ã‚¨ãƒ©ãƒ¼ã€ç„¡åŠ¹ãªå…¥åŠ›ãªã©ã€ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚æ„å‘³ãŒãªã„ã‚¨ãƒ©ãƒ¼
    const nonRetryableStatuses = [400, 401, 403, 404];
    return nonRetryableStatuses.includes(error.statusCode);
  }

  private calculateBackoffDelay(attempt: number, error: any): number {
    // 429ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰ã®å ´åˆã¯å›ºå®šå¾…æ©Ÿ
    if (error.statusCode === 429) {
      return error.retryAfter ? error.retryAfter * 1000 : 10000; // 10ç§’
    }

    // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•: baseDelay * 2^attempt + jitter
    const exponentialDelay = this.baseDelay * Math.pow(2, attempt);
    const jitter = Math.random() * 1000; // æœ€å¤§1ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ é…å»¶
    return Math.min(exponentialDelay + jitter, 30000); // æœ€å¤§30ç§’
  }

  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  private buildPrompt(request: TranslationRequest): PoeApiRequest {
    const systemPrompt = this.getSystemPrompt(request.targetLang);
    const userMessage = this.getUserMessage(request.text, request.sourceLang, request.targetLang);

    return {
      model: this.modelName,
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userMessage },
      ],
      temperature: 0.3,
      max_tokens: 2000,
    };
  }

  private async callApi(prompt: PoeApiRequest): Promise<PoeApiResponse> {
    const response = await fetch(this.endpointUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.apiKey}`,
      },
      body: JSON.stringify(prompt),
    });

    if (!response.ok) {
      const errorText = await response.text();
      const statusCode = response.status;

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸErrorCodeã‚’æ±ºå®š
      let errorCode: ErrorCode;
      if (statusCode === 401 || statusCode === 403) {
        errorCode = ErrorCode.AUTH_ERROR;
      } else if (statusCode === 400) {
        errorCode = ErrorCode.INVALID_INPUT;
      } else if (statusCode === 429) {
        errorCode = ErrorCode.RATE_LIMIT;
      } else if (statusCode >= 500) {
        errorCode = ErrorCode.NETWORK_ERROR;
      } else {
        errorCode = ErrorCode.API_ERROR;
      }

      const error = new TranslationError(
        `Poe API Error: ${statusCode} ${response.statusText} - ${errorText}`,
        errorCode
      );

      // Retry-Afterãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚Œã°å–å¾—
      const retryAfter = response.headers.get('retry-after');
      if (retryAfter) {
        (error as any).retryAfter = parseInt(retryAfter, 10);
      }
      (error as any).statusCode = statusCode;

      throw error;
    }

    return await response.json();
  }

  private getSystemPrompt(targetLang: string): string {
    const langName = targetLang === 'ja' ? 'æ—¥æœ¬èª' : 'ä¸­æ–‡';
    return `ã‚ãªãŸã¯å„ªç§€ãªç¿»è¨³è€…ã§ã™ã€‚ä¸ãˆã‚‰ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªç„¶ã§æ­£ç¢ºãª${langName}ã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚

é‡è¦ãªæŒ‡ç¤ºï¼š
- ç¿»è¨³çµæœã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„
- èª¬æ˜ã‚„è¿½åŠ ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸€åˆ‡ä¸è¦ã§ã™
- å…ƒã®æ„å‘³ã¨ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’ä¿æŒã—ã¦ãã ã•ã„
- è‡ªç„¶ã§æµæš¢ãª${langName}ã«ã—ã¦ãã ã•ã„`;
  }

  private getUserMessage(text: string, sourceLang: string, targetLang: string): string {
    const targetLangName = targetLang === 'ja' ? 'æ—¥æœ¬èª' : 'ä¸­å›½èª';
    return `ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’${targetLangName}ã«ç¿»è¨³ã—ã¦ãã ã•ã„ï¼š\n\n${text}`;
  }
}

interface TranslationRequest {
  text: string;
  sourceLang: string;
  targetLang: string;
}

interface PoeApiRequest {
  model: string;
  messages: Array<{ role: string; content: string }>;
  temperature: number;
  max_tokens: number;
}

interface PoeApiResponse {
  choices: Array<{
    message: {
      content: string;
    };
  }>;
}
```

---

### 6. LanguageDetector

**è²¬å‹™**: è¨€èªã®è‡ªå‹•æ¤œå‡º

```typescript
class LanguageDetector {
  detect(text: string): string {
    // æ–‡å­—ç¨®ã‚’åˆ¤å®š
    const hasHiragana = /[\u3040-\u309f]/.test(text);
    const hasKatakana = /[\u30a0-\u30ff]/.test(text);
    const hasKanji = /[\u4e00-\u9faf]/.test(text);

    // æ—¥æœ¬èªå›ºæœ‰ã®å¥èª­ç‚¹
    const hasJapanesePunctuation = /[ã€ã€‚ã€Œã€ã€ã€ãƒ»]/.test(text);

    // ä¸­å›½èªå›ºæœ‰ã®å¥èª­ç‚¹
    const hasChinesePunctuation = /[ï¼Œã€‚ï¼Ÿï¼ï¼šï¼›""''ã€ã€‘ï¼ˆï¼‰]/.test(text);

    // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãŒã‚ã‚Œã°æ—¥æœ¬èª
    if (hasHiragana || hasKatakana) {
      return 'ja';
    }

    // æ—¥æœ¬èªå¥èª­ç‚¹ãŒã‚ã‚Œã°æ—¥æœ¬èªï¼ˆæ¼¢å­—ã®ã¿ã§ã‚‚åˆ¤å®šå¯èƒ½ï¼‰
    if (hasJapanesePunctuation) {
      return 'ja';
    }

    // ä¸­å›½èªå¥èª­ç‚¹ãŒã‚ã‚Œã°ä¸­å›½èª
    if (hasChinesePunctuation) {
      return 'zh';
    }

    // æ¼¢å­—ã®ã¿ã®å ´åˆ
    if (hasKanji) {
      // å¸¸ç”¨æ¼¢å­—ã®é »åº¦ã§åˆ¤å®šï¼ˆæ—¥æœ¬èªã«å¤šã„æ¼¢å­—ï¼‰
      const jpCommonKanji = /[äººæ—¥æœ¬èªä¸€äºŒä¸‰æ™‚é–“ä¼šç¤¾]/;
      const jpKanjiCount = (text.match(jpCommonKanji) || []).length;

      // æ—¥æœ¬èªã§ã‚ˆãä½¿ã‚ã‚Œã‚‹æ¼¢å­—ãŒå¤šã‘ã‚Œã°æ—¥æœ¬èªã¨åˆ¤å®š
      if (jpKanjiCount > 0) {
        return 'ja';
      }

      // ãã‚Œä»¥å¤–ã¯ä¸­å›½èªã¨åˆ¤å®š
      return 'zh';
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æ—¥æœ¬èª
    return 'ja';
  }
}

// Phase 2: é«˜åº¦ãªè¨€èªæ¤œå‡ºï¼ˆfrancç­‰ï¼‰
import { franc } from 'franc';

class AdvancedLanguageDetector {
  detect(text: string): string {
    const result = franc(text, { only: ['jpn', 'cmn'] });

    switch (result) {
      case 'jpn':
        return 'ja';
      case 'cmn':
        return 'zh';
      default:
        return 'ja';
    }
  }
}
```

---

### 7. RateLimiter

**è²¬å‹™**: APIå‘¼ã³å‡ºã—ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```typescript
class RateLimiter {
  private queue: Array<{resolve: () => void}> = [];
  private activeRequests = 0;
  private maxConcurrent: number;
  private minInterval: number;
  private lastRequestTime = 0;

  constructor(maxConcurrent: number, minInterval: number) {
    this.maxConcurrent = maxConcurrent;
    this.minInterval = minInterval;
  }

  async acquire(): Promise<void> {
    // ã‚¹ãƒ­ãƒƒãƒˆã‚’ç¢ºä¿ã—ã¦ã‹ã‚‰å¾…æ©Ÿå‡¦ç†ã«å…¥ã‚‹
    while (this.activeRequests >= this.maxConcurrent) {
      // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦å¾…æ©Ÿ
      await new Promise<void>((resolve) => {
        this.queue.push({ resolve });
      });
    }

    // ã‚¹ãƒ­ãƒƒãƒˆç¢ºä¿ï¼ˆä»–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã“ã‚Œä»¥ä¸Šå…¥ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
    this.activeRequests++;

    // æœ€å°é–“éš”ã‚’ç¢ºä¿
    const now = Date.now();
    const elapsed = now - this.lastRequestTime;
    if (elapsed < this.minInterval) {
      await this.sleep(this.minInterval - elapsed);
    }

    this.lastRequestTime = Date.now();
  }

  release(): void {
    this.activeRequests--;

    // ã‚­ãƒ¥ãƒ¼ã‹ã‚‰æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†
    if (this.queue.length > 0) {
      const next = this.queue.shift();
      if (next) {
        next.resolve();
      }
    }
  }

  private sleep(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }
}
```

---

### 8. MessageDispatcher

**è²¬å‹™**: ç¿»è¨³çµæœã®æ•´å½¢ãƒ»é€ä¿¡

```typescript
class MessageDispatcher {
  async sendTranslation(
    channel: TextChannel,
    result: TranslationResult,
    originalMessage: Message
  ): Promise<void> {
    const formattedMessage = this.formatMessage(result);

    try {
      await channel.send({
        content: formattedMessage,
        reply: { messageReference: originalMessage.id },
      });
    } catch (error) {
      logger.error('Failed to send translation', { error });
      throw error;
    }
  }

  async sendError(channel: TextChannel, error: Error): Promise<void> {
    const errorMessage = this.formatError(error);
    await channel.send(errorMessage);
  }

  private formatMessage(result: TranslationResult): string {
    const flag = result.sourceLang === 'ja' ? 'ğŸ‡¯ğŸ‡µâ†’ğŸ‡¨ğŸ‡³' : 'ğŸ‡¨ğŸ‡³â†’ğŸ‡¯ğŸ‡µ';
    return `${flag}\n${result.translatedText}`;
  }

  private formatError(error: Error): string {
    // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ã¦å®‰å…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
    if (error instanceof TranslationError) {
      switch (error.code) {
        case ErrorCode.NETWORK_ERROR:
          return 'âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        case ErrorCode.RATE_LIMIT:
          return 'âš ï¸ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        case ErrorCode.AUTH_ERROR:
          return 'âš ï¸ èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        case ErrorCode.API_ERROR:
          return 'âš ï¸ ç¿»è¨³ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        case ErrorCode.INVALID_INPUT:
          return 'âš ï¸ å…¥åŠ›ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        default:
          return 'âš ï¸ ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
      }
    }

    // ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    return 'âš ï¸ ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
  }
}
```

---

### 9. ConfigStore

**è²¬å‹™**: è¨­å®šã®èª­ã¿è¾¼ã¿ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
import { z } from 'zod';

const BotConfigSchema = z.object({
  discord: z.object({
    token: z.string().min(1, 'Discord bot token is required'),
    targetChannels: z.array(z.string()).optional(),
  }),
  poe: z.object({
    apiKey: z.string().min(1, 'Poe API key is required'),
    endpointUrl: z.string().url().default('https://api.poe.com/v1/chat/completions'),
    modelName: z.string().default('Claude-3.5-Sonnet'),
  }),
  rateLimiter: z.object({
    maxConcurrent: z.number().positive().default(1),
    minInterval: z.number().positive().default(1000),
  }),
});

type BotConfig = z.infer<typeof BotConfigSchema>;

class ConfigStore {
  private config: BotConfig;

  constructor() {
    this.config = this.loadConfig();
  }

  private loadConfig(): BotConfig {
    const rawConfig = {
      discord: {
        token: process.env.DISCORD_BOT_TOKEN,
        targetChannels: process.env.TARGET_CHANNELS?.split(','),
      },
      poe: {
        apiKey: process.env.POE_API_KEY,
        endpointUrl: process.env.POE_ENDPOINT_URL,
        modelName: process.env.POE_MODEL_NAME,
      },
      rateLimiter: {
        maxConcurrent: process.env.RATE_LIMIT_CONCURRENT
          ? Number(process.env.RATE_LIMIT_CONCURRENT)
          : undefined,
        minInterval: process.env.RATE_LIMIT_INTERVAL
          ? Number(process.env.RATE_LIMIT_INTERVAL)
          : undefined,
      },
    };

    return BotConfigSchema.parse(rawConfig);
  }

  get(): BotConfig {
    return this.config;
  }
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ç¿»è¨³å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
1. Discord â†’ messageCreate ã‚¤ãƒ™ãƒ³ãƒˆ
   â†“
2. MessageHandler: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - botè‡ªèº«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼Ÿ â†’ ã‚¹ã‚­ãƒƒãƒ—
   - å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ï¼Ÿ â†’ æ¬¡ã¸
   â†“
3. CommandParser: ã‚³ãƒãƒ³ãƒ‰è§£æ
   - "!translate <ãƒ†ã‚­ã‚¹ãƒˆ>" â†’ ç¿»è¨³å‡¦ç†ã¸
   - ãã‚Œä»¥å¤– â†’ ã‚¹ã‚­ãƒƒãƒ—
   â†“
4. TranslationService: ç¿»è¨³å®Ÿè¡Œ
   - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
   - è¨€èªæ¤œå‡º
   - ç¿»è¨³å…ˆè¨€èªæ±ºå®š
   â†“
5. PoeApiClient: APIå‘¼ã³å‡ºã—
   - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
   - Poe APIå‘¼ã³å‡ºã—
   - ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
   â†“
6. MessageDispatcher: çµæœé€ä¿¡
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•´å½¢ï¼ˆå›½æ——çµµæ–‡å­—ä»˜ãï¼‰
   - Discordé€ä¿¡ï¼ˆãƒªãƒ—ãƒ©ã‚¤å½¢å¼ï¼‰
   â†“
7. å®Œäº†
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥

```typescript
class TranslationError extends Error {
  constructor(
    message: string,
    public code: ErrorCode,
    public originalError?: Error
  ) {
    super(message);
    this.name = 'TranslationError';
  }
}

enum ErrorCode {
  NETWORK_ERROR = 'NETWORK_ERROR',
  API_ERROR = 'API_ERROR',
  RATE_LIMIT = 'RATE_LIMIT',
  AUTH_ERROR = 'AUTH_ERROR',
  INVALID_INPUT = 'INVALID_INPUT',
  UNKNOWN = 'UNKNOWN',
}
```

### ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | ãƒªãƒˆãƒ©ã‚¤ | æˆ¦ç•¥ |
|-----------|---------|------|
| NETWORK_ERROR | âœ… | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§3å›ï¼‰ |
| RATE_LIMIT | âœ… | å›ºå®šå¾…æ©Ÿï¼ˆ10ç§’ï¼‰ |
| API_ERROR | âŒ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ |
| AUTH_ERROR | âŒ | ãƒ­ã‚°å‡ºåŠ›ã€ç®¡ç†è€…é€šçŸ¥ |
| INVALID_INPUT | âŒ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ |

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### æ©Ÿå¯†æƒ…å ±ç®¡ç†

- **ç’°å¢ƒå¤‰æ•°**: `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã§ç®¡ç†ï¼ˆGitã«å«ã‚ãªã„ï¼‰
- **Discord Bot Token**: `DISCORD_BOT_TOKEN`
- **Poe API Key**: `POE_API_KEY`

### `.env.example`

```bash
# Discordè¨­å®š
DISCORD_BOT_TOKEN=your_discord_bot_token_here
TARGET_CHANNELS=channel_id_1,channel_id_2

# Poe APIè¨­å®š
POE_API_KEY=your_poe_api_key_here
POE_ENDPOINT_URL=https://api.poe.com/v1/chat/completions
POE_MODEL_NAME=Claude-3.5-Sonnet

# ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­å®š
RATE_LIMIT_CONCURRENT=1
RATE_LIMIT_INTERVAL=1000

# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
LOG_LEVEL=info
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

| æŒ‡æ¨™ | ç›®æ¨™å€¤ | å‚™è€ƒ |
|------|--------|------|
| ç¿»è¨³ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  | < 5ç§’ | Poe APIä¾å­˜ |
| botèµ·å‹•æ™‚é–“ | < 10ç§’ | Discordæ¥ç¶šå«ã‚€ |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | < 256MB | Railway.appç„¡æ–™æ å¯¾å¿œ |
| CPUä½¿ç”¨ç‡ | < 50% | ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ < 10% |
| åŒæ™‚ç¿»è¨³å‡¦ç†æ•° | 1 | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ã‚ˆã‚‹ |

---

## ãƒ­ã‚°è¨­è¨ˆ

### ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«

- **error**: ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã€APIå‘¼ã³å‡ºã—å¤±æ•—
- **warn**: ãƒªãƒˆãƒ©ã‚¤ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- **info**: ç¿»è¨³å®Ÿè¡Œã€botèµ·å‹•ãƒ»åœæ­¢
- **debug**: è©³ç´°ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼

### ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆpinoï¼‰

```json
{
  "level": 30,
  "time": 1697500000000,
  "pid": 1234,
  "hostname": "bot-server",
  "msg": "Translation completed",
  "context": {
    "messageId": "1234567890",
    "userId": "9876543210",
    "sourceLang": "ja",
    "targetLang": "zh",
    "duration": 1234
  }
}
```

---

## APIåˆ¶é™ãƒ»åˆ¶ç´„

### Discord APIåˆ¶é™

- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: 50 req/s
- ã‚°ãƒ­ãƒ¼ãƒãƒ«: 50 req/s
- ãƒãƒ¼ã‚¹ãƒˆ: æœ€å¤§120ç§’é–“

### Poe APIåˆ¶é™

- ãƒ—ãƒ©ãƒ³ã«ã‚ˆã‚‹ï¼ˆè¦ç¢ºèªï¼‰
- ãƒªãƒˆãƒ©ã‚¤: 429ã‚¨ãƒ©ãƒ¼æ™‚ã«å¾…æ©Ÿ

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ç‰ˆ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|------|---|---------|--------|
| 2025-10-17 | 1.0 | åˆç‰ˆä½œæˆ | Claude Code |

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: å®Ÿè£…ã‚¬ã‚¤ãƒ‰ï¼ˆIMPLEMENTATION_GUIDE.mdï¼‰ã®ä½œæˆ
